<!DOCTYPE html>
<html lang="si"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thekinaa EDU </title> <script src="https://cdn.tailwindcss.com"></script>
    </head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-bold" id="home-link">Thekinaa EDU</a>
            <div class="space-x-2">
                <button id="admin-login-btn" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded">Admin Login</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-xl font-bold mb-4">Admin Login</h2>
                <div class="mb-4">
                    <label for="admin-code-input" class="block text-gray-700 mb-2">Admin Code</label> <input id="admin-code-input" type="password" class="w-full border border-gray-300 p-2 rounded"> </div>
                <div id="admin-login-error" class="text-red-500 text-sm mb-4 hidden">Invalid Admin Code</div> <div class="flex justify-end space-x-2">
                    <button id="admin-cancel-btn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">Cancel</button>
                    <button id="admin-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Login</button>
                </div>
            </div>
        </div>

        <div id="category-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-xl font-bold mb-4">Edit Category</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Category Name</label>
                    <input id="edit-category-name" type="text" class="w-full border border-gray-300 p-2 rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Category Thumbnail URL</label>
                    <input id="edit-category-thumbnail" type="text" class="w-full border border-gray-300 p-2 rounded" placeholder="https://example.com/image.jpg">
                     <div class="mt-2">
                        <img id="edit-thumbnail-preview" src="" alt="Thumbnail preview" class="h-16 w-auto object-cover rounded hidden">
                        <span id="edit-no-thumbnail-text" class="text-sm text-gray-500 hidden">No thumbnail set</span>
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="category-edit-cancel-btn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">Cancel</button>
                    <button id="category-edit-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="user-interface" class="mb-8">
            <h1 class="text-3xl font-bold text-center my-8"> </h1> <div id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <p class="text-gray-500 col-span-full text-center">Loading categories...</p>
            </div>

            <div id="videos-container" class="hidden">
                <button id="back-to-categories" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    ← Back to Categories
                </button>
                <h2 id="category-title" class="text-2xl font-bold mb-4"></h2>
                <div id="videos-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-500 col-span-full text-center">Loading videos...</p>
                </div>
            </div>

            <div id="video-player-container" class="hidden">
                <button id="back-to-videos" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    ← Back to Videos
                </button>
                <h2 id="video-title" class="text-2xl font-bold mb-4"></h2>
                <div class="relative mb-4" style="padding-bottom: 56.25%; height: 0; overflow: hidden;">
                     <div id="video-player" class="absolute top-0 left-0 w-full h-full bg-black">
                         </div>
                </div>
                <div id="video-description" class="bg-white p-4 rounded shadow mb-4">
                     </div>
            </div>
        </div>

        <div id="admin-interface" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                <button id="admin-logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Logout</button>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">Manage Categories</h2>
                <div class="flex flex-wrap gap-4 mb-4" id="admin-categories-list">
                    <p class="text-gray-500 w-full">Loading categories...</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 items-end">
                    <div class="flex-grow w-full sm:w-auto">
                        <label for="new-category-input" class="sr-only">New Category Name</label>
                        <input type="text" id="new-category-input" placeholder="New category name" class="border border-gray-300 p-2 rounded w-full mb-2 sm:mb-0">
                    </div>
                     <div class="flex-grow w-full sm:w-auto">
                         <label for="new-category-thumbnail" class="sr-only">New Category Thumbnail URL</label>
                         <input type="text" id="new-category-thumbnail" placeholder="Category thumbnail URL (optional)" class="border border-gray-300 p-2 rounded w-full mb-2 sm:mb-0">
                     </div>
                    <button id="add-category-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full sm:w-auto flex-shrink-0">Add Category</button>
                </div>
                 <div id="admin-category-message" class="text-sm mt-2"></div> </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Add YouTube Video</h2>
                <div class="mb-4">
                    <label for="video-title-input" class="block text-gray-700 mb-2">Video Title</label>
                    <input id="video-title-input" type="text" class="w-full border border-gray-300 p-2 rounded">
                </div>
                <div class="mb-4">
                    <label for="video-description-input" class="block text-gray-700 mb-2">Video Description</label>
                    <textarea id="video-description-input" class="w-full border border-gray-300 p-2 rounded h-32"></textarea>
                </div>
                <div class="mb-4">
                    <label for="video-category-select" class="block text-gray-700 mb-2">Category</label>
                    <select id="video-category-select" class="w-full border border-gray-300 p-2 rounded bg-white">
                         <option value="" disabled selected>Select Category</option>
                         </select>
                </div>
                <div class="mb-4">
                    <label for="youtube-url-input" class="block text-gray-700 mb-2">YouTube Video URL or Embed Code</label>
                    <textarea id="youtube-url-input" placeholder="e.g., https://www.youtube.com/watch?v=VIDEO_ID or <iframe ...></iframe>" class="w-full border border-gray-300 p-2 rounded h-24"></textarea>
                </div>
                <div class="mb-4">
                    <label for="thumbnail-url-input" class="block text-gray-700 mb-2">Video Thumbnail URL (optional)</label>
                    <input id="thumbnail-url-input" type="text" placeholder="Leave blank to attempt auto-fetch (if URL provided)" class="w-full border border-gray-300 p-2 rounded">
                </div>
                <button id="upload-video-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Add Video</button>
                <div id="admin-video-message" class="text-sm mt-2"></div> </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // !!! VERY IMPORTANT: Replace this URL with your actual Google Apps Script Web App URL !!!
        const API_URL = 'https://script.google.com/macros/s/AKfycbzh6FSY3hm1dQRoehWSzVmmT_dRhNXFI1SBpv_b1PK9AyOEtsZcJJaLYFHJVu1iTtG5/exec';
        const ADMIN_ACCESS_CODE = 'thekinaa'; // !!! SECURITY RISK: Hardcoded Admin Code - DO NOT use in production !!!

        // --- DOM Elements ---
        const elements = {
            // Admin Login
            adminLoginBtn: document.getElementById('admin-login-btn'),
            adminLoginModal: document.getElementById('admin-login-modal'),
            adminCancelBtn: document.getElementById('admin-cancel-btn'),
            adminSubmitBtn: document.getElementById('admin-submit-btn'),
            adminCodeInput: document.getElementById('admin-code-input'), // Updated ID
            adminLoginError: document.getElementById('admin-login-error'),

            // Interfaces
            adminInterface: document.getElementById('admin-interface'),
            userInterface: document.getElementById('user-interface'),
            adminLogoutBtn: document.getElementById('admin-logout-btn'),

            // User View Containers
            categoriesContainer: document.getElementById('categories-container'),
            videosContainer: document.getElementById('videos-container'),
            videoPlayerContainer: document.getElementById('video-player-container'),

            // User View Navigation & Content
            backToCategoriesBtn: document.getElementById('back-to-categories'),
            backToVideosBtn: document.getElementById('back-to-videos'),
            categoryTitle: document.getElementById('category-title'),
            videosGrid: document.getElementById('videos-grid'),
            videoPlayer: document.getElementById('video-player'),
            videoTitle: document.getElementById('video-title'),
            videoDescription: document.getElementById('video-description'),
            homeLink: document.getElementById('home-link'),

            // Admin Category Management
            adminCategoriesList: document.getElementById('admin-categories-list'),
            newCategoryInput: document.getElementById('new-category-input'),
            newCategoryThumbnail: document.getElementById('new-category-thumbnail'),
            addCategoryBtn: document.getElementById('add-category-btn'),
            adminCategoryMessage: document.getElementById('admin-category-message'),

            // Admin Video Management
            videoCategorySelect: document.getElementById('video-category-select'),
            videoTitleInput: document.getElementById('video-title-input'),
            videoDescriptionInput: document.getElementById('video-description-input'),
            youtubeUrlInput: document.getElementById('youtube-url-input'),
            thumbnailUrlInput: document.getElementById('thumbnail-url-input'),
            uploadVideoBtn: document.getElementById('upload-video-btn'),
            adminVideoMessage: document.getElementById('admin-video-message'),

             // Category Edit Modal
            categoryEditModal: document.getElementById('category-edit-modal'),
            editCategoryName: document.getElementById('edit-category-name'),
            editCategoryThumbnail: document.getElementById('edit-category-thumbnail'),
            editThumbnailPreview: document.getElementById('edit-thumbnail-preview'),
            editNoThumbnailText: document.getElementById('edit-no-thumbnail-text'),
            categoryEditCancelBtn: document.getElementById('category-edit-cancel-btn'),
            categoryEditSaveBtn: document.getElementById('category-edit-save-btn')
        };

        // --- State ---
        let DB = { categories: [], videos: [] }; // Client-side cache
        let currentEditingCategory = null; // ID of category being edited
        let currentCategory = { id: null, name: null }; // Track currently viewed category for back navigation

        // --- Utility Functions ---
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = `text-sm mt-2 ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => { element.textContent = ''; }, 5000); // Clear message after 5 seconds
        }

        function getYoutubeId(url) {
            // Handles various YouTube URL formats and extracts video ID
            const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getYoutubeEmbedCode(urlOrCode) {
            // Tries to extract ID for standard embed, otherwise assumes it's already an iframe code
            const youtubeId = getYoutubeId(urlOrCode);
            if (youtubeId) {
                // Corrected embed URL
                 return `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${youtubeId}?autoplay=0&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else if (urlOrCode.trim().toLowerCase().startsWith('<iframe')) {
                 // Assume it's already a valid iframe code (basic check)
                 return urlOrCode;
            }
            return null; // Invalid input
        }

        // --- API Call Functions ---
        async function fetchData(endpoint) {
             elements.categoriesContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading...</p>'; // Show loading generally
             elements.videosGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading...</p>';
            try {
                const response = await fetch(`${API_URL}?action=${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                 elements.categoriesContainer.innerHTML = ''; // Clear loading on success
                 elements.videosGrid.innerHTML = '';
                return data;
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                // Show error more visibly
                 elements.categoriesContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Error loading data: ${error.message}. Check API_URL and backend script.</p>`;
                 elements.videosGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Error loading videos: ${error.message}.</p>`;
                return null;
            }
        }

         async function postData(action, payload) {
            // Show generic processing message in admin panels
             showMessage(elements.adminCategoryMessage, 'Processing...', false);
             showMessage(elements.adminVideoMessage, 'Processing...', false);
            try {
               const response = await fetch(API_URL, {
                method: 'POST',
                // Added mode: 'no-cors' to bypass CORS preflight for simple POSTs
                mode: 'no-cors',
                // Keep headers and body - Apps Script doPost needs to handle JSON.stringify(payload) correctly.
                // Note: We cannot easily check response status or body with 'no-cors'.
                headers: {
                   'Content-Type': 'application/json' // Keep this if your Apps Script expects JSON
                },
                body: JSON.stringify({ action: action, ...payload })
            });

                // Try to parse JSON, but handle potential text responses from Apps Script errors
                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                     data = await response.json();
                } else {
                    const textResponse = await response.text();
                    // Attempt to handle non-JSON success/error messages from GAS if needed
                     console.warn("Received non-JSON response:", textResponse);
                     // Assume success if response status is OK, otherwise throw error based on text
                    if (!response.ok) throw new Error(textResponse || `HTTP error! status: ${response.status}`);
                     // If response is ok but not JSON, create a generic success object
                     data = { success: true, message: textResponse || "Operation likely succeeded (non-JSON response)." };
                }

                 if (!response.ok || data.status === 'error' || data.success === false) {
                     throw new Error(data.message || data.error || 'Unknown error');
                 }

                 // Clear processing messages on success
                 elements.adminCategoryMessage.textContent = '';
                 elements.adminVideoMessage.textContent = '';
                 return data; // Contains { success: true, ... }

            } catch (error) {
                console.error(`Error posting action ${action}:`, error);
                // Show error in relevant admin panel
                if (action.toLowerCase().includes('category')) {
                    showMessage(elements.adminCategoryMessage, `Error: ${error.message}`, true);
                } else if (action.toLowerCase().includes('video')) {
                     showMessage(elements.adminVideoMessage, `Error: ${error.message}`, true);
                 } else {
                     alert(`Error performing action ${action}: ${error.message}`); // Fallback alert
                 }
                 return { success: false, error: error.message }; // Return error object
            }
        }


        // --- UI Rendering Functions ---

        function loadCategories() {
            elements.categoriesContainer.classList.remove('hidden');
             elements.videosContainer.classList.add('hidden');
             elements.videoPlayerContainer.classList.add('hidden');
             elements.categoriesContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading categories...</p>'; // Loading indicator

            fetchData('getCategories')
                .then(data => {
                     if (data && data.categories) {
                        DB.categories = data.categories;
                        DB.videos = data.videos || []; // Cache videos if backend sends them together
                        elements.categoriesContainer.innerHTML = ''; // Clear loading/error

                         if (DB.categories.length === 0) {
                             elements.categoriesContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No categories found. Add some via the Admin Panel.</p>';
                             return;
                         }

                        DB.categories.forEach(category => {
                            const categoryCard = document.createElement('div');
                            categoryCard.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow cursor-pointer';
                             // Corrected template literal syntax and placeholder URL
                            categoryCard.innerHTML = `
                                <div class="h-40 bg-gray-200 flex items-center justify-center overflow-hidden">
                                    <img src="${category.thumbnailUrl || 'https://placehold.co/320x180?text=' + encodeURIComponent(category.name)}" alt="${category.name}" class="w-full h-full object-cover">
                                </div>
                                <div class="p-4">
                                    <h3 class="text-xl font-bold mb-1">${category.name}</h3>
                                </div>
                            `;
                             // Removed video count for simplicity as it requires loading all videos initially

                            categoryCard.addEventListener('click', () => {
                                loadVideosByCategory(category.id, category.name);
                            });
                            elements.categoriesContainer.appendChild(categoryCard);
                        });
                     } else if (!data) {
                         // Error message handled by fetchData
                     } else {
                         elements.categoriesContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No categories found.</p>';
                     }
                });
        }

        function loadVideosByCategory(categoryId, categoryName) {
            currentCategory = { id: categoryId, name: categoryName }; // Store for back navigation
            elements.categoriesContainer.classList.add('hidden');
            elements.videosContainer.classList.remove('hidden');
            elements.videoPlayerContainer.classList.add('hidden'); // Hide player when viewing list
            elements.categoryTitle.textContent = categoryName;
            elements.videosGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading videos...</p>'; // Loading indicator

            // Fetch videos specifically for this category
             fetchData(`getVideos&category=${categoryId}`) // Pass category ID
                .then(data => {
                     if (data && data.videos) {
                         DB.videos = data.videos; // Update video cache for this category
                         elements.videosGrid.innerHTML = ''; // Clear loading/error

                         if (DB.videos.length === 0) {
                             elements.videosGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">No videos found in the '${categoryName}' category.</p>`;
                             return;
                         }

                         DB.videos.forEach(video => {
                            const videoCard = document.createElement('div');
                            videoCard.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow cursor-pointer';
                             // Corrected template literal syntax and placeholder URL
                            videoCard.innerHTML = `
                                <div class="relative h-48 bg-gray-200">
                                     <img src="${video.thumbnailUrl || 'https://placehold.co/320x180?text=' + encodeURIComponent(video.title)}" alt="${video.title}" class="w-full h-full object-cover">
                                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h3 class="text-lg font-bold truncate" title="${video.title}">${video.title}</h3>
                                </div>
                            `;

                            videoCard.addEventListener('click', () => {
                                playVideo(video);
                            });
                            elements.videosGrid.appendChild(videoCard);
                        });
                     } else if (!data) {
                         // Error handled by fetchData
                     } else {
                         elements.videosGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">No videos found.</p>`;
                     }
                 });
        }

        function playVideo(video) {
            elements.videosContainer.classList.add('hidden');
            elements.videoPlayerContainer.classList.remove('hidden');

            elements.videoTitle.textContent = video.title;
            elements.videoDescription.textContent = video.description || "No description available."; // Handle missing description

            const videoEmbedCode = getYoutubeEmbedCode(video.videoUrl); // Use utility function

            if (videoEmbedCode) {
                 elements.videoPlayer.innerHTML = videoEmbedCode;
            } else {
                 elements.videoPlayer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-black text-red-500 p-4">Invalid YouTube URL or Embed Code provided.</div>`;
            }
        }

        // --- Admin UI Functions ---

        function loadAdminInterface() {
             // Fetch fresh data for admin view
             fetchData('getAdminData') // Assuming backend provides combined data for admin
                 .then(data => {
                     if (data) {
                         DB.categories = data.categories || [];
                         DB.videos = data.videos || []; // Cache videos if needed
                         renderAdminCategories();
                         updateCategorySelect();
                     } else {
                         // Handle error - fetchData should have displayed a message
                     }
                 });
        }


        function renderAdminCategories() {
            elements.adminCategoriesList.innerHTML = ''; // Clear existing
             if (DB.categories.length === 0) {
                 elements.adminCategoriesList.innerHTML = '<p class="text-gray-500 w-full">No categories yet.</p>';
                 return;
             }

            DB.categories.forEach(category => {
                const categoryChip = document.createElement('div');
                categoryChip.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center text-sm';
                 // Corrected SVGs and template literal
                categoryChip.innerHTML = `
                    <span class="mr-2">${category.name}</span>
                    <button class="text-blue-500 hover:text-blue-700 mr-1 edit-btn p-1" data-category-id="${category.id}" title="Edit Category">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                         </svg>
                     </button>
                    <button class="text-red-500 hover:text-red-700 delete-btn p-1" data-category-id="${category.id}" title="Delete Category">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                         </svg>
                    </button>
                `;
                elements.adminCategoriesList.appendChild(categoryChip);

                // Add event listeners after appending
                categoryChip.querySelector('.edit-btn').addEventListener('click', (event) => {
                    const categoryIdToEdit = event.currentTarget.dataset.categoryId;
                    openEditCategoryModal(categoryIdToEdit);
                });

                categoryChip.querySelector('.delete-btn').addEventListener('click', (event) => {
                    const categoryIdToDelete = event.currentTarget.dataset.categoryId;
                    // Added confirmation message in Sinhala
                    if (confirm(`මෙම Category (${category.name}) එක මැකීමට අවශ්‍යද? (මෙයට අදාළ වීඩියෝ මැකෙන්නේ නැත)`)) {
                        deleteCategory(categoryIdToDelete);
                    }
                });
            });
        }

         function updateCategorySelect() {
             elements.videoCategorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';
             if (DB.categories) {
                 DB.categories.forEach(category => {
                     const option = document.createElement('option');
                     option.value = category.id;
                     option.textContent = category.name;
                     elements.videoCategorySelect.appendChild(option);
                 });
             }
        }

        function openEditCategoryModal(categoryId) {
            const categoryToEdit = DB.categories.find(cat => cat.id === categoryId);
            if (categoryToEdit) {
                currentEditingCategory = categoryId;
                elements.editCategoryName.value = categoryToEdit.name;
                elements.editCategoryThumbnail.value = categoryToEdit.thumbnailUrl || '';
                if (categoryToEdit.thumbnailUrl) {
                     elements.editThumbnailPreview.src = categoryToEdit.thumbnailUrl;
                     elements.editThumbnailPreview.classList.remove('hidden');
                     elements.editNoThumbnailText.classList.add('hidden');
                } else {
                     elements.editThumbnailPreview.classList.add('hidden');
                     elements.editNoThumbnailText.classList.remove('hidden');
                }
                elements.categoryEditModal.classList.remove('hidden');
            } else {
                 console.error("Category not found for editing:", categoryId);
                 showMessage(elements.adminCategoryMessage, "Error: Category not found.", true);
            }
        }

        // --- Admin Action Functions ---

         async function addCategory() {
            const categoryName = elements.newCategoryInput.value.trim();
            // Generate a simple ID (replace spaces, lowercase) - Backend might generate its own ID
             const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-5);
            const thumbnailUrl = elements.newCategoryThumbnail.value.trim(); // Optional

            if (categoryName) {
                const result = await postData('addCategory', { id: categoryId, name: categoryName, thumbnailUrl: thumbnailUrl });
                 if (result.success) {
                     elements.newCategoryInput.value = '';
                     elements.newCategoryThumbnail.value = '';
                     showMessage(elements.adminCategoryMessage, 'Category added successfully!', false);
                     // Refresh admin view and dropdown
                     loadAdminInterface(); // Reloads categories and updates select
                 }
                 // Error message handled by postData
            } else {
                 showMessage(elements.adminCategoryMessage, 'Please enter a category name.', true);
            }
        }

         async function editCategory() {
            if (!currentEditingCategory) return;

            const newName = elements.editCategoryName.value.trim();
            const newThumbnailUrl = elements.editCategoryThumbnail.value.trim();

            if (!newName) {
                 alert('Category name cannot be empty');
                 return;
            }

             const result = await postData('editCategory', { id: currentEditingCategory, name: newName, thumbnailUrl: newThumbnailUrl });

             if (result.success) {
                 showMessage(elements.adminCategoryMessage, 'Category updated successfully!', false);
                 elements.categoryEditModal.classList.add('hidden');
                 currentEditingCategory = null;
                 // Refresh admin view and dropdown
                 loadAdminInterface();
             }
             // Error message handled by postData
        }

        async function deleteCategory(categoryId) {
            const result = await postData('deleteCategory', { id: categoryId });
             if (result.success) {
                 showMessage(elements.adminCategoryMessage, 'Category deleted successfully!', false);
                  // Refresh admin view and dropdown
                 loadAdminInterface();
             }
             // Error message handled by postData
        }

        async function addVideo() {
            const title = elements.videoTitleInput.value.trim();
            const description = elements.videoDescriptionInput.value.trim();
            const category = elements.videoCategorySelect.value;
            const youtubeUrlOrCode = elements.youtubeUrlInput.value.trim();
             let thumbnailUrl = elements.thumbnailUrlInput.value.trim();

            if (!title || !category || !youtubeUrlOrCode) {
                 showMessage(elements.adminVideoMessage,'Please fill Video Title, select Category, and provide YouTube URL/Code.', true);
                 return;
            }

             // Attempt to extract a valid embed code or verify the input
             const finalEmbedCode = getYoutubeEmbedCode(youtubeUrlOrCode); // Check/convert URL to embed code if possible

             if (!finalEmbedCode) {
                  showMessage(elements.adminVideoMessage, 'Invalid YouTube URL or Embed Code provided.', true);
                  return;
             }

             // Simple ID generation (Backend might handle this better)
             const videoId = 'vid-' + Date.now().toString().slice(-8);

             // Basic Auto-Thumbnail attempt if URL was given and thumbnail field is empty
             const youtubeIdForThumb = getYoutubeId(youtubeUrlOrCode);
             if (!thumbnailUrl && youtubeIdForThumb) {
                 thumbnailUrl = `https://img.youtube.com/vi/${youtubeIdForThumb}/mqdefault.jpg`; // Medium quality thumbnail
             }


             const result = await postData('addVideo', {
                 id: videoId,
                 title: title,
                 description: description,
                 category: category,
                 videoUrl: youtubeUrlOrCode, // Store original input maybe? Or just the ID/Embed? Let's store original for now.
                 thumbnailUrl: thumbnailUrl
             });

             if (result.success) {
                 showMessage(elements.adminVideoMessage, 'Video added successfully!', false);
                 // Clear form
                 elements.videoTitleInput.value = '';
                 elements.videoDescriptionInput.value = '';
                 elements.youtubeUrlInput.value = '';
                 elements.thumbnailUrlInput.value = '';
                 elements.videoCategorySelect.selectedIndex = 0;
                 // Optionally refresh video list if viewing the same category, but not critical
             }
             // Error message handled by postData
        }

        // --- Event Listeners ---
        elements.adminLoginBtn.addEventListener('click', () => {
            elements.adminCodeInput.value = ''; // Clear previous attempts
            elements.adminLoginError.classList.add('hidden'); // Hide error
            elements.adminLoginModal.classList.remove('hidden');
            elements.adminCodeInput.focus();
        });

        elements.adminCancelBtn.addEventListener('click', () => {
            elements.adminLoginModal.classList.add('hidden');
        });

        // Modified Admin Submit Logic
        elements.adminSubmitBtn.addEventListener('click', () => {
            const enteredCode = elements.adminCodeInput.value;
            // !!! SECURITY RISK: Client-side check !!!
            if (enteredCode === ADMIN_ACCESS_CODE) {
                elements.adminLoginModal.classList.add('hidden');
                elements.userInterface.classList.add('hidden');
                elements.adminInterface.classList.remove('hidden');
                loadAdminInterface(); // Load data for admin panel
            } else {
                elements.adminLoginError.classList.remove('hidden'); // Show error
            }
        });
         // Allow login with Enter key
         elements.adminCodeInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
                 elements.adminSubmitBtn.click();
             }
         });

        elements.adminLogoutBtn.addEventListener('click', () => {
            elements.adminInterface.classList.add('hidden');
            elements.userInterface.classList.remove('hidden');
            // Reset user view to categories
            elements.videosContainer.classList.add('hidden');
            elements.videoPlayerContainer.classList.add('hidden');
            elements.categoriesContainer.classList.remove('hidden');
            loadCategories(); // Refresh categories view
        });

        elements.backToCategoriesBtn.addEventListener('click', () => {
            elements.videosContainer.classList.add('hidden');
            elements.categoriesContainer.classList.remove('hidden');
        });

        elements.backToVideosBtn.addEventListener('click', () => {
            elements.videoPlayerContainer.classList.add('hidden');
             // Need to know which category's videos to show
            if (currentCategory.id) {
                 elements.videosContainer.classList.remove('hidden');
                 // Optionally reload videos for the currentCategory.id or assume DB.videos is still relevant
            } else {
                 // Fallback to categories if current category isn't known
                 elements.videosContainer.classList.add('hidden');
                 elements.categoriesContainer.classList.remove('hidden');
            }
             elements.videoPlayer.innerHTML = ''; // Stop video playback
        });

         elements.homeLink.addEventListener('click', (e) => {
             e.preventDefault();
             elements.adminInterface.classList.add('hidden'); // Hide admin if showing
             elements.userInterface.classList.remove('hidden');
             elements.videosContainer.classList.add('hidden');
             elements.videoPlayerContainer.classList.add('hidden');
             elements.categoriesContainer.classList.remove('hidden');
             loadCategories(); // Load main categories view
         });

        // Admin Action Button Listeners
        elements.addCategoryBtn.addEventListener('click', addCategory);
        elements.uploadVideoBtn.addEventListener('click', addVideo);
        elements.categoryEditSaveBtn.addEventListener('click', editCategory);

        elements.categoryEditCancelBtn.addEventListener('click', () => {
            elements.categoryEditModal.classList.add('hidden');
            currentEditingCategory = null;
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             // Check if API_URL is set
             if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                 elements.categoriesContainer.innerHTML = '<p class="text-red-500 font-bold col-span-full text-center p-4 border border-red-500 rounded">ERROR: API_URL is not set in the script. Please deploy the Google Apps Script and update the API_URL constant.</p>';
                 return; // Stop further execution
             }
             loadCategories(); // Load initial category view for users
        });

    </script>
</body>
</html>
